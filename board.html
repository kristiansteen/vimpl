<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vimpl - Visual Planning Board</title>
    
    <!-- GridStack CSS -->
    <link href="https://cdn.jsdelivr.net/npm/gridstack@10.0.0/dist/gridstack.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/gridstack@10.0.0/dist/gridstack-extra.min.css" rel="stylesheet"/>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Modern Color Palette */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #0ea5e9;
            --accent: #f59e0b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --dark-lighter: #334155;
            --light: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            
            --grid-size: 20px;
            
            /* Post-it Colors - Modern */
            --postit-yellow: #fef08a;
            --postit-pink: #fda4af;
            --postit-blue: #93c5fd;
            --postit-green: #86efac;
            --postit-orange: #fdba74;
            --postit-done: #cbd5e1;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: white;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--gray-200);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            z-index: 100;
            position: relative;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            min-width: 120px;
        }
        
        .logo span {
            font-weight: 300;
            opacity: 0.7;
        }
        
        .logo-link {
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: opacity 0.2s;
        }
        
        .logo-link:hover {
            opacity: 0.8;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .header-title {
            flex: 1;
            display: flex;
            justify-content: center;
            padding: 0 20px;
        }
        
        .project-title-input {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            background: transparent;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 8px 16px;
            text-align: center;
            min-width: 200px;
            max-width: 400px;
            width: 100%;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .project-title-input:hover {
            background: var(--gray-100);
        }
        
        .project-title-input:focus {
            outline: none;
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .project-title-input::placeholder {
            color: var(--gray-400);
            font-weight: 400;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
        }
        
        .btn-secondary:hover {
            background: var(--gray-200);
        }
        
        /* Main Container */
        .main-container {
            display: flex;
            height: calc(100vh - 65px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 70px;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 0;
            gap: 8px;
            z-index: 50;
        }
        
        .sidebar-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: var(--gray-400);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .sidebar-btn:hover {
            background: var(--dark-lighter);
            color: white;
        }
        
        .sidebar-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .sidebar-divider {
            width: 32px;
            height: 1px;
            background: var(--dark-lighter);
            margin: 8px 0;
        }
        
        .sidebar-label {
            color: var(--gray-500);
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }
        
        /* Post-it Color Palette */
        .postit-palette {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 4px;
        }
        
        .postit-color {
            width: 36px;
            height: 36px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s;
            position: relative;
        }
        
        .postit-color:hover {
            transform: scale(1.1);
        }
        
        .postit-color.selected {
            border-color: white;
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .postit-color.yellow { background: var(--postit-yellow); }
        .postit-color.pink { background: var(--postit-pink); }
        .postit-color.blue { background: var(--postit-blue); }
        .postit-color.green { background: var(--postit-green); }
        .postit-color.orange { background: var(--postit-orange); }
        
        /* Board Area */
        .board-area {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        
        /* Grid Background */
        .grid-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(99, 102, 241, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(99, 102, 241, 0.08) 1px, transparent 1px);
            background-size: var(--grid-size) var(--grid-size);
            pointer-events: none;
            z-index: 0;
        }
        
        /* GridStack Customization */
        .grid-stack {
            background: transparent;
            min-height: 100%;
            padding: 12px;
        }
        
        .grid-stack-item-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--gray-200);
        }
        
        /* Section Styles */
        .section-header {
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-lighter) 100%);
            color: white;
            padding: 10px 14px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            font-size: 13px;
        }
        
        .section-header.locked {
            cursor: default;
            background: linear-gradient(135deg, var(--gray-500) 0%, var(--gray-600) 100%);
        }
        
        .section-title {
            background: transparent;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 13px;
            flex: 1;
            outline: none;
            font-family: inherit;
        }
        
        .section-title:focus {
            border-bottom: 1px dashed rgba(255,255,255,0.5);
        }
        
        .section-controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .section-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            opacity: 0.7;
            transition: all 0.2s;
            font-size: 12px;
        }
        
        .section-btn:hover {
            opacity: 1;
            background: rgba(255,255,255,0.2);
        }
        
        .section-btn.locked {
            color: var(--warning);
            opacity: 1;
        }
        
        .section-content {
            flex: 1;
            padding: 12px;
            position: relative;
            overflow: auto;
            min-height: 100px;
        }
        
        /* Dropzone highlight */
        .section-content.drag-over {
            background: rgba(99, 102, 241, 0.05);
            outline: 2px dashed var(--primary);
        }
        
        /* Text Section */
        .text-content {
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            font-size: 13px;
            line-height: 1.5;
            outline: none;
            font-family: inherit;
            color: var(--dark);
        }
        
        /* Week Planner Section */
        .week-planner-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .week-planner-settings {
            padding: 8px 12px;
            background: var(--gray-100);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }
        
        .week-planner-settings label {
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .week-planner-settings input[type="date"] {
            padding: 4px 8px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
        }
        
        .week-planner {
            display: flex;
            height: 100%;
            overflow: auto;
            position: relative;
        }
        
        .track-column {
            min-width: 120px;
            background: var(--gray-100);
            border-right: 2px solid var(--primary);
            position: sticky;
            left: 0;
            z-index: 10;
        }
        
        .track-header {
            background: var(--primary);
            color: white;
            padding: 10px;
            font-weight: 600;
            text-align: center;
            font-size: 12px;
        }
        
        .track-item {
            padding: 8px 10px;
            border-bottom: 1px solid var(--gray-200);
            min-height: 70px;
            height: 70px;
            background: var(--gray-100);
            display: flex;
            align-items: center;
        }
        
        .track-item input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 12px;
            font-family: inherit;
            color: var(--dark);
        }
        
        .weeks-container {
            display: flex;
            flex: 1;
        }
        
        .week-column {
            min-width: 90px;
            border-right: 1px solid var(--gray-200);
        }
        
        .week-header {
            background: var(--gray-200);
            padding: 10px 8px;
            font-weight: 600;
            text-align: center;
            font-size: 11px;
            color: var(--gray-600);
        }
        
        .week-cell {
            min-height: 70px;
            height: 70px;
            border-bottom: 1px solid var(--gray-100);
            position: relative;
            padding: 4px;
            overflow: hidden;
        }
        
        .week-cell.drag-over {
            background: rgba(99, 102, 241, 0.1);
        }
        
        /* Highlighted Week */
        .week-column.current .week-header {
            background: var(--success);
            color: white;
        }
        
        /* Two-by-Two Matrix */
        .matrix-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            padding: 10px;
        }
        
        .matrix-y-label {
            position: absolute;
            left: -5px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            font-size: 11px;
            color: var(--gray-500);
            white-space: nowrap;
            font-weight: 500;
        }
        
        .matrix-y-label input {
            border: none;
            background: transparent;
            font-size: 11px;
            color: var(--gray-500);
            width: 120px;
            text-align: center;
            font-family: inherit;
        }
        
        .matrix-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            margin-left: 25px;
            margin-bottom: 25px;
            margin-top: 5px;
            margin-right: 5px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            min-height: 150px;
        }
        
        .matrix-quadrant {
            border: 1px solid var(--gray-200);
            position: relative;
            min-height: 60px;
            background: white;
        }
        
        /* Risk matrix colors - top-left is high risk (red), bottom-right is low risk (green) */
        .matrix-quadrant:nth-child(1) { background: rgba(254, 202, 202, 0.5); } /* top-left - high consequence, low probability */
        .matrix-quadrant:nth-child(2) { background: rgba(254, 178, 178, 0.5); } /* top-right - high consequence, high probability - highest risk */
        .matrix-quadrant:nth-child(3) { background: rgba(187, 247, 208, 0.5); } /* bottom-left - low consequence, low probability - lowest risk */
        .matrix-quadrant:nth-child(4) { background: rgba(254, 240, 138, 0.5); } /* bottom-right - low consequence, high probability */
        
        .matrix-quadrant.drag-over {
            background: rgba(99, 102, 241, 0.2);
        }
        
        .matrix-x-label {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: var(--gray-500);
            font-weight: 500;
        }
        
        .matrix-x-label input {
            border: none;
            background: transparent;
            font-size: 11px;
            color: var(--gray-500);
            text-align: center;
            width: 150px;
            font-family: inherit;
        }
        
        /* Post-it Notes */
        .postit {
            width: 42px;
            height: 42px;
            padding: 4px;
            border-radius: 4px;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.15);
            cursor: grab;
            position: absolute;
            font-size: 8px;
            line-height: 1.2;
            overflow: hidden;
            z-index: 5;
            transition: box-shadow 0.2s, transform 0.2s;
            perspective: 1000px;
        }
        
        .postit:hover {
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            z-index: 6;
        }
        
        .postit.dragging {
            cursor: grabbing;
            box-shadow: 4px 4px 12px rgba(0,0,0,0.25);
            z-index: 1000;
            opacity: 0.9;
        }
        
        .postit.done {
            background: var(--postit-done) !important;
        }
        
        .postit-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .postit.flipped .postit-inner {
            transform: rotateY(180deg);
        }
        
        .postit-front, .postit-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        
        .postit-front textarea {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            resize: none;
            font-size: 8px;
            line-height: 1.2;
            outline: none;
            font-family: inherit;
        }
        
        .postit-back {
            transform: rotateY(180deg);
            background: inherit;
            border-radius: 4px;
        }
        
        .postit-delete {
            position: absolute;
            top: 1px;
            right: 1px;
            width: 12px;
            height: 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 8px;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .postit:hover .postit-delete {
            display: flex;
        }
        
        /* Post-it Form (Back) */
        .postit-form {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 16px;
            z-index: 2000;
            width: 280px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .postit-form h4 {
            font-size: 14px;
            color: var(--dark);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .postit-form .form-group {
            margin-bottom: 10px;
        }
        
        .postit-form label {
            display: block;
            font-size: 11px;
            color: var(--gray-500);
            margin-bottom: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .postit-form input,
        .postit-form select,
        .postit-form textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        .postit-form input:focus,
        .postit-form select:focus,
        .postit-form textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .postit-form textarea {
            resize: none;
            height: 60px;
        }
        
        .postit-form .score-display {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            padding: 8px;
            background: var(--gray-100);
            border-radius: 6px;
        }
        
        .postit-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .postit-form .close-form {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            color: var(--gray-400);
            cursor: pointer;
        }
        
        .postit-form .close-form:hover {
            color: var(--dark);
        }
        
        /* KPI Section */
        .kpi-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .kpi-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: var(--gray-100);
            border-radius: 8px;
            border: 1px solid var(--gray-200);
        }
        
        .kpi-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .kpi-indicator.red { background: var(--danger); }
        .kpi-indicator.yellow { background: var(--warning); }
        .kpi-indicator.green { background: var(--success); }
        
        .kpi-item input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 13px;
            font-family: inherit;
        }
        
        .kpi-add {
            margin-top: 8px;
            padding: 10px;
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            color: var(--gray-500);
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .kpi-add:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }
        
        /* Actions Table */
        .actions-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .actions-table th,
        .actions-table td {
            padding: 8px;
            border: 1px solid var(--gray-200);
        }
        
        .actions-table th {
            background: var(--gray-100);
            font-weight: 600;
            color: var(--gray-600);
            text-align: left;
        }
        
        .actions-table input, 
        .actions-table select {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 12px;
            font-family: inherit;
        }
        
        .actions-table .add-row {
            text-align: center;
            cursor: pointer;
            color: var(--primary);
        }
        
        .actions-table .add-row:hover {
            background: rgba(99, 102, 241, 0.05);
        }
        
        /* Team Table */
        .team-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .team-table th,
        .team-table td {
            padding: 8px;
            border: 1px solid var(--gray-200);
        }
        
        .team-table th {
            background: var(--gray-100);
            font-weight: 600;
            color: var(--gray-600);
            text-align: left;
        }
        
        .team-table th:last-child {
            width: 30px;
        }
        
        .team-table input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 12px;
            font-family: inherit;
            padding: 2px 0;
        }
        
        .team-table input:focus {
            outline: none;
            background: var(--gray-50);
        }
        
        .team-table .team-delete-btn {
            color: var(--gray-400);
            padding: 2px 6px;
        }
        
        .team-table .team-delete-btn:hover {
            color: var(--danger);
        }
        
        .team-table .add-team-row {
            text-align: center;
            cursor: pointer;
            color: var(--primary);
        }
        
        .team-table .add-team-row:hover {
            background: rgba(99, 102, 241, 0.05);
        }
        
        .team-table .add-team-row td {
            padding: 10px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close {
            background: var(--gray-100);
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray-500);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: var(--gray-200);
            color: var(--dark);
        }
        
        .modal-body {
            flex: 1;
            overflow: auto;
            padding: 24px;
        }
        
        /* Event Log Table */
        .event-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .event-table th,
        .event-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .event-table th {
            background: var(--dark);
            color: white;
            position: sticky;
            top: 0;
            font-weight: 500;
        }
        
        .event-table tr:hover {
            background: var(--gray-50);
        }
        
        .event-type {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .event-type.create { background: #dcfce7; color: #166534; }
        .event-type.move { background: #dbeafe; color: #1e40af; }
        .event-type.edit { background: #fef9c3; color: #a16207; }
        .event-type.delete { background: #fee2e2; color: #991b1b; }
        .event-type.resize { background: #f3e8ff; color: #7c3aed; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 16px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: var(--gray-500);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            font-family: inherit;
            font-weight: 500;
        }
        
        .tab:hover {
            color: var(--dark);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        /* Add Section Modal */
        .section-types {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        
        .section-type-card {
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 24px 16px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .section-type-card:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-2px);
        }
        
        .section-type-card i {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 12px;
        }
        
        .section-type-card h3 {
            font-size: 14px;
            color: var(--dark);
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        .section-type-card p {
            font-size: 12px;
            color: var(--gray-500);
        }
        
        /* Instructions tooltip */
        .instructions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--dark);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 12px;
            max-width: 280px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 100;
        }
        
        .instructions h4 {
            margin-bottom: 10px;
            color: var(--primary-light);
            font-size: 13px;
        }
        
        .instructions ul {
            margin-left: 16px;
            line-height: 1.6;
        }
        
        .instructions li {
            margin-bottom: 4px;
        }
        
        .instructions .close-btn {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            color: var(--gray-400);
            font-size: 16px;
            cursor: pointer;
        }
        
        /* Auto-save indicator */
        .autosave-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--gray-500);
        }
        
        .autosave-indicator.saving {
            color: var(--warning);
        }
        
        .autosave-indicator.saved {
            color: var(--success);
        }
        
        .autosave-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray-400);
        }
        
        .autosave-indicator.saving .autosave-dot {
            background: var(--warning);
            animation: pulse 1s infinite;
        }
        
        .autosave-indicator.saved .autosave-dot {
            background: var(--success);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Resize Handle */
        .gs-resizable-handle {
            background: var(--primary);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <a href="index.html" class="logo-link" title="Back to Home">
            <div class="logo">vimpl<span>.com</span></div>
        </a>
        <div class="header-title">
            <input type="text" id="projectTitle" class="project-title-input" value="Project name" placeholder="Enter project name..." />
        </div>
        <div class="header-controls">
            <div class="autosave-indicator" id="autosaveIndicator">
                <span class="autosave-dot"></span>
                <span class="autosave-text">All changes saved</span>
            </div>
            <button class="btn btn-secondary" id="newBoard">
                <i class="fas fa-file"></i> New
            </button>
            <button class="btn btn-secondary" id="toggleGrid">
                <i class="fas fa-th"></i> Grid
            </button>
            <button class="btn btn-secondary" id="showBackend">
                <i class="fas fa-database"></i> Events
            </button>
            <button class="btn btn-primary" id="exportBoard">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </header>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <button class="sidebar-btn active" id="selectTool" title="Select">
                <i class="fas fa-mouse-pointer"></i>
            </button>
            <button class="sidebar-btn" id="addSection" title="Add Section">
                <i class="fas fa-plus"></i>
            </button>
            
            <div class="sidebar-divider"></div>
            
            <div class="sidebar-label">Notes</div>
            <div class="postit-palette" id="postitPalette">
                <div class="postit-color yellow" data-color="yellow" title="Yellow"></div>
                <div class="postit-color pink" data-color="pink" title="Pink"></div>
                <div class="postit-color blue" data-color="blue" title="Blue"></div>
                <div class="postit-color green" data-color="green" title="Green"></div>
                <div class="postit-color orange" data-color="orange" title="Orange"></div>
            </div>
        </aside>
        
        <!-- Board Area -->
        <main class="board-area" id="boardArea">
            <div class="grid-background" id="gridBackground"></div>
            <div class="grid-stack" id="board"></div>
        </main>
    </div>
    
    <!-- Post-it Form (appears on double-click) -->
    <div class="postit-form" id="postitForm" style="display: none;">
        <button class="close-form" id="closePostitForm">&times;</button>
        <h4><i class="fas fa-sticky-note"></i> <span id="formTitle">Edit Note</span></h4>
        
        <div class="form-group">
            <label>Content</label>
            <textarea id="formContent" placeholder="Enter note content..."></textarea>
        </div>
        
        <div class="form-group">
            <label>Owner</label>
            <select id="formOwner">
                <option value="">-- Select Owner --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Status</label>
            <select id="formStatus">
                <option value="todo">To Do</option>
                <option value="inprogress">In Progress</option>
                <option value="done">Done</option>
            </select>
        </div>
        
        <!-- Risk Matrix Fields (shown conditionally) -->
        <div id="riskFields" style="display: none;">
            <div class="form-row">
                <div class="form-group">
                    <label id="xAxisLabel">X Value (1-100)</label>
                    <input type="number" id="formXValue" min="1" max="100" value="50">
                </div>
                <div class="form-group">
                    <label id="yAxisLabel">Y Value (1-100)</label>
                    <input type="number" id="formYValue" min="1" max="100" value="50">
                </div>
            </div>
            <div class="form-group">
                <label>Risk Score</label>
                <div class="score-display" id="scoreDisplay">2500</div>
            </div>
            <div class="form-group">
                <label>Mitigation (max 255 chars)</label>
                <textarea id="formMitigation" maxlength="255" placeholder="Describe mitigation strategy..."></textarea>
            </div>
        </div>
    </div>
    
    <!-- Instructions -->
    <div class="instructions" id="instructions">
        <button class="close-btn" onclick="this.parentElement.style.display='none'">&times;</button>
        <h4><i class="fas fa-lightbulb"></i> Quick Start</h4>
        <ul>
            <li><strong>Add Note:</strong> Click color â†’ click section</li>
            <li><strong>Edit Note:</strong> Double-click to open form</li>
            <li><strong>Move Note:</strong> Drag within sections</li>
            <li><strong>Lock Section:</strong> Click lock icon</li>
            <li><strong>Auto-save:</strong> Changes save automatically</li>
        </ul>
    </div>
    
    <!-- Backend Event Log Modal -->
    <div class="modal-overlay" id="backendModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-database"></i> Event Log</h2>
                <button class="modal-close" id="closeBackend">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" data-tab="events">All Events</button>
                    <button class="tab" data-tab="postits">Post-it Data</button>
                    <button class="tab" data-tab="matrix">Matrix Positions</button>
                </div>
                <div id="eventsTab">
                    <table class="event-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Event</th>
                                <th>Element ID</th>
                                <th>Type</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="eventLogBody"></tbody>
                    </table>
                </div>
                <div id="postitsTab" style="display:none;">
                    <table class="event-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Color</th>
                                <th>Content</th>
                                <th>Owner</th>
                                <th>Status</th>
                                <th>X</th>
                                <th>Y</th>
                            </tr>
                        </thead>
                        <tbody id="postitLogBody"></tbody>
                    </table>
                </div>
                <div id="matrixTab" style="display:none;">
                    <table class="event-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Post-it ID</th>
                                <th>Matrix</th>
                                <th>X-Axis</th>
                                <th>X (0-100)</th>
                                <th>Y-Axis</th>
                                <th>Y (0-100)</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody id="matrixLogBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Section Modal -->
    <div class="modal-overlay" id="addSectionModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> Add New Section</h2>
                <button class="modal-close" id="closeAddSection">&times;</button>
            </div>
            <div class="modal-body">
                <div class="section-types" id="sectionTypes">
                    <div class="section-type-card" data-type="text">
                        <i class="fas fa-align-left"></i>
                        <h3>Text Section</h3>
                        <p>Simple text area for notes</p>
                    </div>
                    <div class="section-type-card" data-type="team">
                        <i class="fas fa-users"></i>
                        <h3>Team Section</h3>
                        <p>Team members with name & email</p>
                    </div>
                    <div class="section-type-card" data-type="kpi">
                        <i class="fas fa-chart-line"></i>
                        <h3>KPI Section</h3>
                        <p>Key performance indicators</p>
                    </div>
                    <div class="section-type-card" data-type="matrix">
                        <i class="fas fa-th-large"></i>
                        <h3>2x2 Matrix</h3>
                        <p>Risk/Impact analysis grid</p>
                    </div>
                    <div class="section-type-card" data-type="weekplan">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>Week Planner</h3>
                        <p>Weekly schedule with tracks</p>
                    </div>
                    <div class="section-type-card" data-type="actions">
                        <i class="fas fa-tasks"></i>
                        <h3>Actions Table</h3>
                        <p>Action items with owners</p>
                    </div>
                    <div class="section-type-card" data-type="postit-area">
                        <i class="fas fa-sticky-note"></i>
                        <h3>Post-it Area</h3>
                        <p>Free area for sticky notes</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GridStack JS -->
    <script src="https://cdn.jsdelivr.net/npm/gridstack@10.0.0/dist/gridstack-all.js"></script>
    
    <script>
        // ========================================
        // VIMPL PLANNING BOARD APPLICATION v2
        // ========================================
        
        const AppState = {
            grid: null,
            postits: {},
            eventLog: [],
            matrixLog: [],
            teamMembers: [],
            gridSize: 20,
            showGrid: true,
            selectedColor: null,
            currentPostitId: null,
            lockedSections: new Set(),
            autoSaveTimeout: null
        };
        
        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        
        function generateId(prefix = 'item') {
            return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }
        
        function formatTimestamp(date = new Date()) {
            return date.toISOString().replace('T', ' ').substr(0, 19);
        }
        
        function logEvent(type, elementId, elementType, details) {
            const event = {
                timestamp: formatTimestamp(),
                type,
                elementId,
                elementType,
                details: typeof details === 'object' ? JSON.stringify(details) : details
            };
            AppState.eventLog.unshift(event);
            if (AppState.eventLog.length > 500) AppState.eventLog.pop();
            scheduleAutoSave();
        }
        
        function logMatrixPosition(postitId, sectionId, xLabel, xValue, yLabel, yValue, score) {
            const entry = {
                timestamp: formatTimestamp(),
                postitId,
                sectionId,
                xLabel,
                xValue: Math.round(xValue),
                yLabel,
                yValue: Math.round(yValue),
                score
            };
            AppState.matrixLog.unshift(entry);
            if (AppState.matrixLog.length > 500) AppState.matrixLog.pop();
        }
        
        function snapToGrid(value) {
            return Math.round(value / AppState.gridSize) * AppState.gridSize;
        }
        
        function getPostitColor(colorName) {
            const colors = {
                yellow: 'var(--postit-yellow)',
                pink: 'var(--postit-pink)',
                blue: 'var(--postit-blue)',
                green: 'var(--postit-green)',
                orange: 'var(--postit-orange)'
            };
            return colors[colorName] || colors.yellow;
        }
        
        // ========================================
        // AUTO-SAVE FUNCTIONALITY
        // ========================================
        
        function scheduleAutoSave() {
            clearTimeout(AppState.autoSaveTimeout);
            showAutoSaveStatus('saving');
            AppState.autoSaveTimeout = setTimeout(() => {
                saveBoardState();
                showAutoSaveStatus('saved');
            }, 1000);
        }
        
        function showAutoSaveStatus(status) {
            const indicator = document.getElementById('autosaveIndicator');
            const text = indicator.querySelector('.autosave-text');
            indicator.className = 'autosave-indicator ' + status;
            text.textContent = status === 'saving' ? 'Saving...' : 'All changes saved';
        }
        
        function saveBoardState() {
            try {
                const gridData = AppState.grid.save(true);
                
                // Save section content
                const sectionContent = {};
                document.querySelectorAll('.grid-stack-item').forEach(item => {
                    const id = item.getAttribute('gs-id');
                    const textarea = item.querySelector('.text-content');
                    if (textarea) {
                        sectionContent[id] = { text: textarea.value };
                    }
                    const title = item.querySelector('.section-title');
                    if (title) {
                        sectionContent[id] = sectionContent[id] || {};
                        sectionContent[id].title = title.value;
                    }
                });
                
                // Get project title
                const projectTitle = document.getElementById('projectTitle')?.value || 'Project name';
                
                // Update team members from table
                updateTeamMembersFromTable();
                
                const state = {
                    grid: gridData,
                    postits: AppState.postits,
                    eventLog: AppState.eventLog.slice(0, 100),
                    matrixLog: AppState.matrixLog.slice(0, 100),
                    lockedSections: Array.from(AppState.lockedSections),
                    sectionContent,
                    projectTitle,
                    teamMembers: AppState.teamMembers,
                    version: 2
                };
                localStorage.setItem('vimplBoardState', JSON.stringify(state));
            } catch (e) {
                console.error('Save error:', e);
            }
        }
        
        function loadBoardState() {
            const saved = localStorage.getItem('vimplBoardState');
            if (!saved) return false;
            
            try {
                const state = JSON.parse(saved);
                if (state.version !== 2) return false;
                
                AppState.grid.load(state.grid);
                AppState.postits = state.postits || {};
                AppState.eventLog = state.eventLog || [];
                AppState.matrixLog = state.matrixLog || [];
                AppState.lockedSections = new Set(state.lockedSections || []);
                AppState.teamMembers = state.teamMembers || [];
                
                // Restore project title
                if (state.projectTitle) {
                    document.getElementById('projectTitle').value = state.projectTitle;
                }
                
                // Restore section content after a delay
                setTimeout(() => {
                    if (state.sectionContent) {
                        Object.keys(state.sectionContent).forEach(id => {
                            const item = document.querySelector(`[gs-id="${id}"]`);
                            if (item && state.sectionContent[id]) {
                                const textarea = item.querySelector('.text-content');
                                if (textarea && state.sectionContent[id].text) {
                                    textarea.value = state.sectionContent[id].text;
                                }
                                const title = item.querySelector('.section-title');
                                if (title && state.sectionContent[id].title) {
                                    title.value = state.sectionContent[id].title;
                                }
                            }
                        });
                    }
                    
                    // Restore team members in the table
                    if (state.teamMembers && state.teamMembers.length > 0) {
                        const tbody = document.querySelector('.team-members-body');
                        if (tbody) {
                            // Remove existing rows except add-row
                            tbody.querySelectorAll('.team-member-row').forEach(row => row.remove());
                            
                            // Add team members
                            const addRow = tbody.querySelector('.add-team-row');
                            state.teamMembers.forEach(member => {
                                const row = document.createElement('tr');
                                row.className = 'team-member-row';
                                row.setAttribute('data-member-id', member.id || 'member_' + Date.now());
                                row.innerHTML = `
                                    <td><input type="text" class="team-name" placeholder="Name" value="${member.name || ''}" /></td>
                                    <td><input type="email" class="team-email" placeholder="email@example.com" value="${member.email || ''}" /></td>
                                    <td><button class="section-btn team-delete-btn"><i class="fas fa-times"></i></button></td>
                                `;
                                tbody.insertBefore(row, addRow);
                            });
                        }
                    }
                    
                    // Restore post-its
                    Object.values(AppState.postits).forEach(postitData => {
                        const section = document.querySelector(`[gs-id="${postitData.section}"]`);
                        if (section) {
                            const dropzone = section.querySelector('.postit-dropzone');
                            if (dropzone) {
                                restorePostit(postitData, dropzone);
                            }
                        }
                    });
                    
                    // Restore locked sections
                    AppState.lockedSections.forEach(id => {
                        updateSectionLockUI(id, true);
                    });
                    
                    initializeDropzones();
                    attachSectionEventListeners();
                    updateAllOwnerDropdowns();
                }, 300);
                
                return true;
            } catch (e) {
                console.error('Load error:', e);
                return false;
            }
        }
        
        function restorePostit(data, parentElement) {
            const postit = document.createElement('div');
            postit.className = 'postit' + (data.status === 'done' ? ' done' : '');
            postit.id = data.id;
            postit.style.backgroundColor = getPostitColor(data.color);
            postit.style.left = data.x + 'px';
            postit.style.top = data.y + 'px';
            postit.setAttribute('data-color', data.color);
            
            postit.innerHTML = `
                <div class="postit-inner">
                    <div class="postit-front">
                        <textarea placeholder="...">${data.content || ''}</textarea>
                    </div>
                </div>
                <button class="postit-delete">&times;</button>
            `;
            
            parentElement.appendChild(postit);
            makePostitDraggable(postit);
            attachPostitEvents(postit);
        }
        
        // ========================================
        // SECTION TEMPLATES
        // ========================================
        
        function createSectionHeader(title, showLock = true, extraButtons = '') {
            return `
                <div class="section-header">
                    <input type="text" class="section-title" value="${title}" />
                    <div class="section-controls">
                        ${extraButtons}
                        ${showLock ? '<button class="section-btn lock-btn" title="Lock Section"><i class="fas fa-unlock"></i></button>' : ''}
                        <button class="section-btn delete-section-btn" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }
        
        function createTextSection(title = 'New Section') {
            return `
                ${createSectionHeader(title)}
                <div class="section-content postit-dropzone">
                    <textarea class="text-content" placeholder="Enter text here..."></textarea>
                </div>
            `;
        }
        
        function createTeamSection(title = 'Team') {
            return `
                ${createSectionHeader(title)}
                <div class="section-content">
                    <table class="team-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody class="team-members-body">
                            <tr class="team-member-row" data-member-id="member_1">
                                <td><input type="text" class="team-name" placeholder="Name" value="" /></td>
                                <td><input type="email" class="team-email" placeholder="email@example.com" value="" /></td>
                                <td><button class="section-btn team-delete-btn"><i class="fas fa-times"></i></button></td>
                            </tr>
                            <tr class="add-team-row">
                                <td colspan="3"><i class="fas fa-plus"></i> Add Team Member</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function createKPISection(title = 'Project KPIs') {
            return `
                ${createSectionHeader(title)}
                <div class="section-content">
                    <div class="kpi-container">
                        <div class="kpi-item">
                            <div class="kpi-indicator green" data-status="green" onclick="cycleKPIStatus(this)"></div>
                            <input type="text" value="Cost" />
                            <button class="section-btn kpi-delete-btn"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-indicator green" data-status="green" onclick="cycleKPIStatus(this)"></div>
                            <input type="text" value="Quality" />
                            <button class="section-btn kpi-delete-btn"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-indicator green" data-status="green" onclick="cycleKPIStatus(this)"></div>
                            <input type="text" value="Time" />
                            <button class="section-btn kpi-delete-btn"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="kpi-add">
                        <i class="fas fa-plus"></i> Add KPI
                    </div>
                </div>
            `;
        }
        
        function createMatrixSection(title = 'Risk Matrix', xLabel = 'Probability', yLabel = 'Consequence') {
            const id = generateId('matrix');
            return `
                ${createSectionHeader(title)}
                <div class="section-content matrix-section" data-matrix-id="${id}" data-x-label="${xLabel}" data-y-label="${yLabel}">
                    <div class="matrix-container">
                        <div class="matrix-y-label">
                            <input type="text" value="${yLabel} â†’" class="y-axis-label" />
                        </div>
                        <div class="matrix-grid postit-dropzone matrix-dropzone" data-matrix-id="${id}">
                            <div class="matrix-quadrant postit-dropzone"></div>
                            <div class="matrix-quadrant postit-dropzone"></div>
                            <div class="matrix-quadrant postit-dropzone"></div>
                            <div class="matrix-quadrant postit-dropzone"></div>
                        </div>
                        <div class="matrix-x-label">
                            <input type="text" value="${xLabel} â†’" class="x-axis-label" />
                        </div>
                    </div>
                </div>
            `;
        }
        
        function createWeekPlanSection(title = 'Week Plan', numWeeks = 12, numTracks = 5) {
            const today = new Date().toISOString().split('T')[0];
            
            let weeksHtml = '';
            for (let i = 0; i < numWeeks; i++) {
                let cellsHtml = '';
                for (let t = 0; t < numTracks; t++) {
                    cellsHtml += `<div class="week-cell postit-dropzone"></div>`;
                }
                weeksHtml += `
                    <div class="week-column" data-week-index="${i}">
                        <div class="week-header">Week ${i + 1}</div>
                        ${cellsHtml}
                    </div>
                `;
            }
            
            let tracksHtml = '';
            for (let i = 1; i <= numTracks; i++) {
                tracksHtml += `
                    <div class="track-item">
                        <input type="text" value="Track ${i}" />
                    </div>
                `;
            }
            
            const extraBtns = `
                <button class="section-btn add-week-btn" title="Add Week"><i class="fas fa-plus"></i></button>
                <button class="section-btn add-track-btn" title="Add Track"><i class="fas fa-layer-group"></i></button>
                <button class="section-btn calendar-btn" title="Calendar Settings"><i class="fas fa-calendar-alt"></i></button>
            `;
            
            return `
                ${createSectionHeader(title, true, extraBtns)}
                <div class="section-content" style="padding: 0; display: flex; flex-direction: column;">
                    <div class="week-planner-wrapper">
                        <div class="week-planner-settings">
                            <label>Start Date:</label>
                            <input type="date" class="week-start-date" value="${today}" onchange="updateWeekNumbers(this)" />
                        </div>
                        <div class="week-planner">
                            <div class="track-column">
                                <div class="track-header">Track</div>
                                ${tracksHtml}
                            </div>
                            <div class="weeks-container">
                                ${weeksHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function createActionsSection(title = 'Actions') {
            return `
                ${createSectionHeader(title)}
                <div class="section-content">
                    <table class="actions-table">
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>When</th>
                                <th>Who</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" placeholder="Enter action..." /></td>
                                <td><input type="date" /></td>
                                <td><select class="action-owner-select"><option value="">-- Select --</option></select></td>
                                <td>
                                    <select>
                                        <option value="todo">To Do</option>
                                        <option value="inprogress">In Progress</option>
                                        <option value="done">Done</option>
                                    </select>
                                </td>
                            </tr>
                            <tr class="add-row">
                                <td colspan="4"><i class="fas fa-plus"></i> Add Action</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function createPostitAreaSection(title = 'Ideas') {
            return `
                ${createSectionHeader(title)}
                <div class="section-content postit-dropzone" style="min-height: 200px;"></div>
            `;
        }
        
        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        
        function updateWeekNumbers(input) {
            const startDate = new Date(input.value);
            const section = input.closest('.grid-stack-item-content');
            const weekColumns = section.querySelectorAll('.week-column');
            
            weekColumns.forEach((col, index) => {
                const weekDate = new Date(startDate);
                weekDate.setDate(weekDate.getDate() + (index * 7));
                const weekNum = getWeekNumber(weekDate);
                col.querySelector('.week-header').textContent = `W${weekNum}`;
                
                // Highlight current week
                const now = new Date();
                const currentWeekNum = getWeekNumber(now);
                col.classList.toggle('current', weekNum === currentWeekNum && weekDate.getFullYear() === now.getFullYear());
            });
            
            scheduleAutoSave();
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        function cycleKPIStatus(indicator) {
            const statuses = ['green', 'yellow', 'red'];
            const current = indicator.getAttribute('data-status');
            const nextIndex = (statuses.indexOf(current) + 1) % 3;
            const next = statuses[nextIndex];
            
            indicator.setAttribute('data-status', next);
            indicator.className = 'kpi-indicator ' + next;
            scheduleAutoSave();
        }
        
        // ========================================
        // TEAM MEMBERS MANAGEMENT
        // ========================================
        
        function updateTeamMembersFromTable() {
            AppState.teamMembers = [];
            document.querySelectorAll('.team-member-row').forEach(row => {
                const name = row.querySelector('.team-name')?.value?.trim();
                const email = row.querySelector('.team-email')?.value?.trim();
                if (name) {
                    AppState.teamMembers.push({ 
                        id: row.getAttribute('data-member-id'),
                        name, 
                        email 
                    });
                }
            });
            updateAllOwnerDropdowns();
            scheduleAutoSave();
        }
        
        function updateAllOwnerDropdowns() {
            // Update the post-it form dropdown
            const formOwner = document.getElementById('formOwner');
            if (formOwner) {
                const currentValue = formOwner.value;
                formOwner.innerHTML = '<option value="">-- Select Owner --</option>';
                AppState.teamMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.name;
                    option.textContent = member.name + (member.email ? ` (${member.email})` : '');
                    formOwner.appendChild(option);
                });
                formOwner.value = currentValue;
            }
            
            // Update action table dropdowns if any exist
            document.querySelectorAll('.action-owner-select').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Select --</option>';
                AppState.teamMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.name;
                    option.textContent = member.name;
                    select.appendChild(option);
                });
                select.value = currentValue;
            });
        }
        
        function addTeamMemberRow(tbody) {
            const memberId = 'member_' + Date.now();
            const newRow = document.createElement('tr');
            newRow.className = 'team-member-row';
            newRow.setAttribute('data-member-id', memberId);
            newRow.innerHTML = `
                <td><input type="text" class="team-name" placeholder="Name" value="" /></td>
                <td><input type="email" class="team-email" placeholder="email@example.com" value="" /></td>
                <td><button class="section-btn team-delete-btn"><i class="fas fa-times"></i></button></td>
            `;
            
            // Insert before the add row
            const addRow = tbody.querySelector('.add-team-row');
            tbody.insertBefore(newRow, addRow);
            
            // Attach events
            attachTeamRowEvents(newRow);
            
            // Focus on the name field
            newRow.querySelector('.team-name').focus();
            
            scheduleAutoSave();
        }
        
        function attachTeamRowEvents(row) {
            const nameInput = row.querySelector('.team-name');
            const emailInput = row.querySelector('.team-email');
            const deleteBtn = row.querySelector('.team-delete-btn');
            
            if (nameInput) {
                nameInput.addEventListener('input', updateTeamMembersFromTable);
                nameInput.addEventListener('change', updateTeamMembersFromTable);
            }
            if (emailInput) {
                emailInput.addEventListener('input', updateTeamMembersFromTable);
                emailInput.addEventListener('change', updateTeamMembersFromTable);
            }
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    row.remove();
                    updateTeamMembersFromTable();
                });
            }
        }
        
        // ========================================
        // POST-IT MANAGEMENT
        // ========================================
        
        function createPostit(color, x, y, parentElement, data = {}) {
            const id = data.id || generateId('postit');
            const postit = document.createElement('div');
            postit.className = 'postit' + (data.status === 'done' ? ' done' : '');
            postit.id = id;
            postit.style.backgroundColor = getPostitColor(color);
            postit.style.left = snapToGrid(x) + 'px';
            postit.style.top = snapToGrid(y) + 'px';
            postit.setAttribute('data-color', color);
            
            postit.innerHTML = `
                <div class="postit-inner">
                    <div class="postit-front">
                        <textarea placeholder="...">${data.content || ''}</textarea>
                    </div>
                </div>
                <button class="postit-delete">&times;</button>
            `;
            
            parentElement.appendChild(postit);
            
            // Determine section type
            const sectionContent = parentElement.closest('.section-content');
            const matrixSection = sectionContent?.classList.contains('matrix-section');
            const weekPlanCell = parentElement.classList.contains('week-cell');
            
            // Store post-it data
            const postitData = {
                id,
                color,
                x: snapToGrid(x),
                y: snapToGrid(y),
                content: data.content || '',
                owner: data.owner || '',
                status: data.status || 'todo',
                section: parentElement.closest('.grid-stack-item')?.getAttribute('gs-id') || 'unknown',
                isMatrix: matrixSection,
                isWeekPlan: weekPlanCell,
                xValue: data.xValue || 50,
                yValue: data.yValue || 50,
                mitigation: data.mitigation || ''
            };
            AppState.postits[id] = postitData;
            
            makePostitDraggable(postit);
            attachPostitEvents(postit);
            
            logEvent('create', id, 'postit', { color, x: snapToGrid(x), y: snapToGrid(y) });
            scheduleAutoSave();
            
            return postit;
        }
        
        function attachPostitEvents(postit) {
            const id = postit.id;
            
            // Delete button
            postit.querySelector('.postit-delete').addEventListener('click', (e) => {
                e.stopPropagation();
                deletePostit(id);
            });
            
            // Content change
            const textarea = postit.querySelector('textarea');
            textarea.addEventListener('input', () => {
                if (AppState.postits[id]) {
                    AppState.postits[id].content = textarea.value;
                    scheduleAutoSave();
                }
            });
            
            // Double-click to open form
            postit.addEventListener('dblclick', (e) => {
                if (e.target.tagName !== 'TEXTAREA') {
                    openPostitForm(id, e.clientX, e.clientY);
                }
            });
        }
        
        function makePostitDraggable(postit) {
            let isDragging = false;
            let startX, startY, origLeft, origTop;
            
            postit.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'BUTTON') return;
                
                isDragging = true;
                postit.classList.add('dragging');
                startX = e.clientX;
                startY = e.clientY;
                origLeft = postit.offsetLeft;
                origTop = postit.offsetTop;
                e.preventDefault();
            });
            
            const onMouseMove = (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                postit.style.left = snapToGrid(origLeft + dx) + 'px';
                postit.style.top = snapToGrid(origTop + dy) + 'px';
            };
            
            const onMouseUp = () => {
                if (!isDragging) return;
                isDragging = false;
                postit.classList.remove('dragging');
                
                const id = postit.id;
                const newX = parseInt(postit.style.left);
                const newY = parseInt(postit.style.top);
                
                if (AppState.postits[id]) {
                    AppState.postits[id].x = newX;
                    AppState.postits[id].y = newY;
                    
                    // Update matrix position if in matrix
                    const matrixDropzone = postit.closest('.matrix-dropzone');
                    if (matrixDropzone) {
                        updateMatrixPositionFromDrag(postit, matrixDropzone);
                    }
                }
                
                logEvent('move', id, 'postit', { x: newX, y: newY });
                scheduleAutoSave();
            };
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }
        
        function deletePostit(id) {
            const postit = document.getElementById(id);
            if (postit) {
                postit.remove();
                delete AppState.postits[id];
                logEvent('delete', id, 'postit', 'Deleted');
                scheduleAutoSave();
            }
        }
        
        function updateMatrixPositionFromDrag(postit, matrix) {
            const matrixRect = matrix.getBoundingClientRect();
            const postitRect = postit.getBoundingClientRect();
            
            const centerX = (postitRect.left + postitRect.width / 2) - matrixRect.left;
            const centerY = (postitRect.top + postitRect.height / 2) - matrixRect.top;
            
            const xPercent = Math.max(1, Math.min(100, Math.round((centerX / matrixRect.width) * 100)));
            const yPercent = Math.max(1, Math.min(100, Math.round(100 - (centerY / matrixRect.height) * 100)));
            
            const id = postit.id;
            if (AppState.postits[id]) {
                AppState.postits[id].xValue = xPercent;
                AppState.postits[id].yValue = yPercent;
                
                const section = matrix.closest('.matrix-section');
                const xLabel = section?.querySelector('.x-axis-label')?.value || 'X';
                const yLabel = section?.querySelector('.y-axis-label')?.value || 'Y';
                const score = xPercent * yPercent;
                
                logMatrixPosition(id, matrix.getAttribute('data-matrix-id'), xLabel, xPercent, yLabel, yPercent, score);
            }
        }
        
        // ========================================
        // POST-IT FORM
        // ========================================
        
        function openPostitForm(id, clickX, clickY) {
            const data = AppState.postits[id];
            if (!data) return;
            
            AppState.currentPostitId = id;
            const form = document.getElementById('postitForm');
            
            // Position form
            const formWidth = 280;
            const formHeight = 400;
            let x = clickX + 10;
            let y = clickY + 10;
            
            if (x + formWidth > window.innerWidth) x = clickX - formWidth - 10;
            if (y + formHeight > window.innerHeight) y = window.innerHeight - formHeight - 10;
            
            form.style.left = x + 'px';
            form.style.top = Math.max(10, y) + 'px';
            form.style.display = 'block';
            
            // Update owner dropdown with current team members
            updateAllOwnerDropdowns();
            
            // Fill form
            document.getElementById('formContent').value = data.content || '';
            document.getElementById('formOwner').value = data.owner || '';
            document.getElementById('formStatus').value = data.status || 'todo';
            
            // Show/hide risk fields
            const riskFields = document.getElementById('riskFields');
            if (data.isMatrix) {
                riskFields.style.display = 'block';
                document.getElementById('formXValue').value = data.xValue || 50;
                document.getElementById('formYValue').value = data.yValue || 50;
                document.getElementById('formMitigation').value = data.mitigation || '';
                updateScoreDisplay();
                
                // Get axis labels
                const postit = document.getElementById(id);
                const section = postit?.closest('.matrix-section');
                if (section) {
                    const xLabel = section.querySelector('.x-axis-label')?.value || 'X Value';
                    const yLabel = section.querySelector('.y-axis-label')?.value || 'Y Value';
                    document.getElementById('xAxisLabel').textContent = xLabel.replace(' â†’', '') + ' (1-100)';
                    document.getElementById('yAxisLabel').textContent = yLabel.replace(' â†’', '') + ' (1-100)';
                }
            } else {
                riskFields.style.display = 'none';
            }
            
            // Set form title
            document.getElementById('formTitle').textContent = data.isMatrix ? 'Risk Item' : (data.isWeekPlan ? 'Task' : 'Note');
        }
        
        function closePostitForm() {
            document.getElementById('postitForm').style.display = 'none';
            AppState.currentPostitId = null;
        }
        
        function savePostitForm() {
            const id = AppState.currentPostitId;
            if (!id || !AppState.postits[id]) return;
            
            const data = AppState.postits[id];
            data.content = document.getElementById('formContent').value;
            data.owner = document.getElementById('formOwner').value;
            data.status = document.getElementById('formStatus').value;
            
            if (data.isMatrix) {
                data.xValue = parseInt(document.getElementById('formXValue').value) || 50;
                data.yValue = parseInt(document.getElementById('formYValue').value) || 50;
                data.mitigation = document.getElementById('formMitigation').value;
                
                // Update postit position in matrix based on values
                updatePostitPositionInMatrix(id);
            }
            
            // Update postit display
            const postit = document.getElementById(id);
            if (postit) {
                postit.querySelector('textarea').value = data.content;
                
                // Update done status
                if (data.status === 'done') {
                    postit.classList.add('done');
                } else {
                    postit.classList.remove('done');
                }
            }
            
            logEvent('edit', id, 'postit', { status: data.status, owner: data.owner });
            scheduleAutoSave();
        }
        
        function updatePostitPositionInMatrix(id) {
            const data = AppState.postits[id];
            const postit = document.getElementById(id);
            if (!postit || !data.isMatrix) return;
            
            const matrix = postit.closest('.matrix-dropzone');
            if (!matrix) return;
            
            const matrixRect = matrix.getBoundingClientRect();
            const postitSize = 42;
            
            // Convert percentage to position
            const x = (data.xValue / 100) * matrixRect.width - postitSize / 2;
            const y = ((100 - data.yValue) / 100) * matrixRect.height - postitSize / 2;
            
            postit.style.left = Math.max(0, x) + 'px';
            postit.style.top = Math.max(0, y) + 'px';
            
            data.x = Math.max(0, x);
            data.y = Math.max(0, y);
        }
        
        function updateScoreDisplay() {
            const x = parseInt(document.getElementById('formXValue').value) || 0;
            const y = parseInt(document.getElementById('formYValue').value) || 0;
            document.getElementById('scoreDisplay').textContent = x * y;
        }
        
        // ========================================
        // SECTION LOCKING
        // ========================================
        
        function toggleSectionLock(sectionId) {
            const isLocked = AppState.lockedSections.has(sectionId);
            
            if (isLocked) {
                AppState.lockedSections.delete(sectionId);
            } else {
                AppState.lockedSections.add(sectionId);
            }
            
            updateSectionLockUI(sectionId, !isLocked);
            updateGridLock();
            scheduleAutoSave();
        }
        
        function updateSectionLockUI(sectionId, locked) {
            const item = document.querySelector(`[gs-id="${sectionId}"]`);
            if (!item) return;
            
            const header = item.querySelector('.section-header');
            const lockBtn = item.querySelector('.lock-btn');
            
            if (locked) {
                header?.classList.add('locked');
                if (lockBtn) {
                    lockBtn.classList.add('locked');
                    lockBtn.innerHTML = '<i class="fas fa-lock"></i>';
                }
            } else {
                header?.classList.remove('locked');
                if (lockBtn) {
                    lockBtn.classList.remove('locked');
                    lockBtn.innerHTML = '<i class="fas fa-unlock"></i>';
                }
            }
        }
        
        function updateGridLock() {
            document.querySelectorAll('.grid-stack-item').forEach(item => {
                const id = item.getAttribute('gs-id');
                const locked = AppState.lockedSections.has(id);
                AppState.grid.update(item, { noMove: locked, noResize: locked });
            });
        }
        
        // ========================================
        // INITIALIZATION
        // ========================================
        
        function initializeGrid() {
            AppState.grid = GridStack.init({
                column: 12,
                cellHeight: 80,
                margin: 8,
                float: true,
                animate: true,
                draggable: { handle: '.section-header' },
                resizable: { handles: 'e, se, s, sw, w' }
            });
            
            AppState.grid.on('resizestop dragstop', () => {
                setTimeout(initializeDropzones, 100);
                scheduleAutoSave();
            });
            
            AppState.grid.on('added', () => {
                setTimeout(() => {
                    initializeDropzones();
                    attachSectionEventListeners();
                }, 100);
            });
        }
        
        function initializePostitPalette() {
            document.querySelectorAll('.postit-color').forEach(colorBtn => {
                colorBtn.addEventListener('click', () => {
                    const color = colorBtn.getAttribute('data-color');
                    
                    document.querySelectorAll('.postit-color').forEach(c => c.classList.remove('selected'));
                    
                    if (AppState.selectedColor === color) {
                        AppState.selectedColor = null;
                        document.body.style.cursor = 'default';
                    } else {
                        AppState.selectedColor = color;
                        colorBtn.classList.add('selected');
                        document.body.style.cursor = 'crosshair';
                    }
                });
            });
        }
        
        function initializeDropzones() {
            document.querySelectorAll('.postit-dropzone').forEach(dropzone => {
                dropzone.removeEventListener('click', handleDropzoneClick);
                dropzone.addEventListener('click', handleDropzoneClick);
            });
        }
        
        function handleDropzoneClick(e) {
            if (!AppState.selectedColor) return;
            if (e.target.closest('.postit')) return;
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
            
            const dropzone = e.currentTarget;
            const rect = dropzone.getBoundingClientRect();
            const x = e.clientX - rect.left - 21;
            const y = e.clientY - rect.top - 21;
            
            createPostit(AppState.selectedColor, Math.max(0, x), Math.max(0, y), dropzone);
            
            AppState.selectedColor = null;
            document.querySelectorAll('.postit-color').forEach(c => c.classList.remove('selected'));
            document.body.style.cursor = 'default';
        }
        
        function attachSectionEventListeners() {
            // Delete section
            document.querySelectorAll('.delete-section-btn').forEach(btn => {
                btn.onclick = function() {
                    const item = this.closest('.grid-stack-item');
                    if (item && confirm('Delete this section?')) {
                        const id = item.getAttribute('gs-id');
                        AppState.grid.removeWidget(item);
                        AppState.lockedSections.delete(id);
                        logEvent('delete', id, 'section', 'Deleted');
                        scheduleAutoSave();
                    }
                };
            });
            
            // Lock section
            document.querySelectorAll('.lock-btn').forEach(btn => {
                btn.onclick = function() {
                    const item = this.closest('.grid-stack-item');
                    if (item) {
                        toggleSectionLock(item.getAttribute('gs-id'));
                    }
                };
            });
            
            // KPI delete
            document.querySelectorAll('.kpi-delete-btn').forEach(btn => {
                btn.onclick = function() {
                    this.closest('.kpi-item')?.remove();
                    scheduleAutoSave();
                };
            });
            
            // KPI add
            document.querySelectorAll('.kpi-add').forEach(btn => {
                btn.onclick = function() {
                    const container = this.previousElementSibling;
                    const item = document.createElement('div');
                    item.className = 'kpi-item';
                    item.innerHTML = `
                        <div class="kpi-indicator green" data-status="green" onclick="cycleKPIStatus(this)"></div>
                        <input type="text" value="New KPI" />
                        <button class="section-btn kpi-delete-btn"><i class="fas fa-times"></i></button>
                    `;
                    container.appendChild(item);
                    item.querySelector('.kpi-delete-btn').onclick = function() { item.remove(); scheduleAutoSave(); };
                    scheduleAutoSave();
                };
            });
            
            // Action row add
            document.querySelectorAll('.add-row').forEach(row => {
                row.onclick = function() {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" placeholder="Enter action..." /></td>
                        <td><input type="date" /></td>
                        <td><select class="action-owner-select"><option value="">-- Select --</option></select></td>
                        <td><select><option value="todo">To Do</option><option value="inprogress">In Progress</option><option value="done">Done</option></select></td>
                    `;
                    this.parentElement.insertBefore(newRow, this);
                    updateAllOwnerDropdowns();
                    scheduleAutoSave();
                };
            });
            
            // Week plan buttons
            document.querySelectorAll('.add-week-btn').forEach(btn => {
                btn.onclick = function() {
                    const section = this.closest('.grid-stack-item-content');
                    const weeksContainer = section.querySelector('.weeks-container');
                    const numWeeks = weeksContainer.children.length;
                    const numTracks = section.querySelectorAll('.track-item').length;
                    
                    const newWeek = document.createElement('div');
                    newWeek.className = 'week-column';
                    newWeek.setAttribute('data-week-index', numWeeks);
                    let cells = '';
                    for (let i = 0; i < numTracks; i++) {
                        cells += '<div class="week-cell postit-dropzone"></div>';
                    }
                    newWeek.innerHTML = `<div class="week-header">Week ${numWeeks + 1}</div>${cells}`;
                    weeksContainer.appendChild(newWeek);
                    
                    // Update week numbers
                    const dateInput = section.querySelector('.week-start-date');
                    if (dateInput) updateWeekNumbers(dateInput);
                    
                    initializeDropzones();
                    scheduleAutoSave();
                };
            });
            
            document.querySelectorAll('.add-track-btn').forEach(btn => {
                btn.onclick = function() {
                    const section = this.closest('.grid-stack-item-content');
                    const trackColumn = section.querySelector('.track-column');
                    const weeksContainer = section.querySelector('.weeks-container');
                    
                    const trackItem = document.createElement('div');
                    trackItem.className = 'track-item';
                    trackItem.innerHTML = '<input type="text" value="New Track" />';
                    trackColumn.appendChild(trackItem);
                    
                    weeksContainer.querySelectorAll('.week-column').forEach(week => {
                        const cell = document.createElement('div');
                        cell.className = 'week-cell postit-dropzone';
                        week.appendChild(cell);
                    });
                    
                    initializeDropzones();
                    scheduleAutoSave();
                };
            });
            
            // Auto-save on input changes
            document.querySelectorAll('.section-title, .text-content, .track-item input').forEach(input => {
                input.addEventListener('input', scheduleAutoSave);
            });
            
            // Attach team table events
            attachTeamTableEvents();
        }
        
        function attachTeamTableEvents() {
            // Add team member row button
            document.querySelectorAll('.add-team-row').forEach(row => {
                row.onclick = function() {
                    const tbody = this.closest('tbody');
                    addTeamMemberRow(tbody);
                };
            });
            
            // Attach events to existing team member rows
            document.querySelectorAll('.team-member-row').forEach(row => {
                attachTeamRowEvents(row);
            });
            
            // Initial update of team members
            updateTeamMembersFromTable();
        }
        
        function addSection(type, options = {}) {
            const id = generateId('section');
            let content = '';
            let w = 3, h = 3;
            
            switch(type) {
                case 'text':
                    content = createTextSection(options.title || 'New Section');
                    w = 2; h = 3;
                    break;
                case 'team':
                    content = createTeamSection(options.title || 'Team');
                    w = 2; h = 3;
                    break;
                case 'kpi':
                    content = createKPISection(options.title || 'Project KPIs');
                    w = 2; h = 3;
                    break;
                case 'matrix':
                    content = createMatrixSection(options.title || 'Risk Matrix', options.xLabel || 'Probability', options.yLabel || 'Consequence');
                    w = 2; h = 4;
                    break;
                case 'weekplan':
                    content = createWeekPlanSection(options.title || 'Week Plan');
                    w = 8; h = 5;
                    break;
                case 'actions':
                    content = createActionsSection(options.title || 'Actions');
                    w = 3; h = 3;
                    break;
                case 'postit-area':
                    content = createPostitAreaSection(options.title || 'Ideas');
                    w = 3; h = 4;
                    break;
            }
            
            AppState.grid.addWidget({ id, w, h, content });
            logEvent('create', id, 'section', { type });
            
            // If team section, attach events after creation
            if (type === 'team') {
                setTimeout(() => {
                    attachTeamTableEvents();
                }, 100);
            }
        }
        
        function createDefaultBoard() {
            // Layout based on screenshot:
            // Left column (x=0, w=2): Project Name, Team, Purpose, Success Criteria
            // Middle (x=2, w=8): Week Plan (top), Actions (bottom)
            // Right column (x=10, w=2): KPIs, Project Risk, Improvement Ideas
            
            // Left column - stacked vertically
            AppState.grid.addWidget({
                id: generateId('section'),
                x: 0, y: 0, w: 2, h: 2,
                content: createTextSection('Project Name')
            });
            
            AppState.grid.addWidget({
                id: generateId('section'),
                x: 0, y: 2, w: 2, h: 2,
                content: createTeamSection('Team')
            });
            
            AppState.grid.addWidget({
                id: generateId('section'),
                x: 0, y: 4, w: 2, h: 2,
                content: createTextSection('Purpose')
            });
            
            AppState.grid.addWidget({
                id: generateId('section'),
                x: 0, y: 6, w: 2, h: 2,
                content: createTextSection('Success Criteria')
            });
            
            // Middle column - Week Plan on top, Actions below
            AppState.grid.addWidget({
                id: generateId('section'),
                x: 2, y: 0, w: 8, h: 6,
                content: createWeekPlanSection('Week Plan')
            });
            
            AppState.grid.addWidget({
                id: generateId('section'),
                x: 2, y: 6, w: 8, h: 3,
                content: createActionsSection('Actions')
            });
            
            // Right column - KPIs, Risk Matrix, Improvement Ideas
            AppState.grid.addWidget({
                id: generateId('section'),
                x: 10, y: 0, w: 2, h: 3,
                content: createKPISection("Project KPI's")
            });
            
            AppState.grid.addWidget({
                id: generateId('section'),
                x: 10, y: 3, w: 2, h: 3,
                content: createMatrixSection('Project Risk', 'Probability', 'Consequence')
            });
            
            AppState.grid.addWidget({
                id: generateId('section'),
                x: 10, y: 6, w: 2, h: 3,
                content: createMatrixSection('Improvement Ideas', 'Ease', 'Impact')
            });
            
            // Initialize after all widgets are added
            setTimeout(() => {
                initializeDropzones();
                attachSectionEventListeners();
                attachTeamTableEvents();
                
                // Update week numbers for all week plans
                document.querySelectorAll('.week-start-date').forEach(input => {
                    updateWeekNumbers(input);
                });
            }, 100);
        }
        
        function updateDisplays() {
            // Events tab
            const eventBody = document.getElementById('eventLogBody');
            if (eventBody) {
                eventBody.innerHTML = AppState.eventLog.slice(0, 100).map(e => `
                    <tr>
                        <td>${e.timestamp}</td>
                        <td><span class="event-type ${e.type}">${e.type}</span></td>
                        <td>${e.elementId}</td>
                        <td>${e.elementType}</td>
                        <td>${e.details}</td>
                    </tr>
                `).join('');
            }
            
            // Postits tab
            const postitBody = document.getElementById('postitLogBody');
            if (postitBody) {
                postitBody.innerHTML = Object.values(AppState.postits).map(p => `
                    <tr>
                        <td>${p.id}</td>
                        <td><span style="background:${getPostitColor(p.color)};padding:2px 8px;border-radius:4px;">${p.color}</span></td>
                        <td>${p.content || '-'}</td>
                        <td>${p.owner || '-'}</td>
                        <td>${p.status}</td>
                        <td>${Math.round(p.x)}</td>
                        <td>${Math.round(p.y)}</td>
                    </tr>
                `).join('');
            }
            
            // Matrix tab
            const matrixBody = document.getElementById('matrixLogBody');
            if (matrixBody) {
                matrixBody.innerHTML = AppState.matrixLog.slice(0, 100).map(m => `
                    <tr>
                        <td>${m.timestamp}</td>
                        <td>${m.postitId}</td>
                        <td>${m.sectionId}</td>
                        <td>${m.xLabel}</td>
                        <td>${m.xValue}</td>
                        <td>${m.yLabel}</td>
                        <td>${m.yValue}</td>
                        <td><strong>${m.score}</strong></td>
                    </tr>
                `).join('');
            }
        }
        
        // ========================================
        // EVENT LISTENERS
        // ========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeGrid();
            initializePostitPalette();
            
            // Check for ?new=true URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const isNewBoard = urlParams.get('new') === 'true';
            
            if (isNewBoard) {
                // Clear any existing state and create fresh board
                localStorage.removeItem('vimplBoardState');
                AppState.postits = {};
                AppState.eventLog = [];
                AppState.matrixLog = [];
                AppState.lockedSections = new Set();
                AppState.teamMembers = [];
                
                // Remove the ?new=true from URL without reload
                window.history.replaceState({}, document.title, window.location.pathname);
                
                createDefaultBoard();
            } else {
                // Try to load saved state
                const loaded = loadBoardState();
                if (!loaded) {
                    createDefaultBoard();
                }
            }
            
            setTimeout(() => {
                initializeDropzones();
                attachSectionEventListeners();
            }, 600);
            
            // Grid toggle
            document.getElementById('toggleGrid').addEventListener('click', () => {
                AppState.showGrid = !AppState.showGrid;
                document.getElementById('gridBackground').style.display = AppState.showGrid ? 'block' : 'none';
            });
            
            // New Board
            document.getElementById('newBoard').addEventListener('click', () => {
                if (confirm('Create a new board? This will clear the current board.')) {
                    localStorage.removeItem('vimplBoardState');
                    AppState.postits = {};
                    AppState.eventLog = [];
                    AppState.matrixLog = [];
                    AppState.lockedSections = new Set();
                    AppState.teamMembers = [];
                    
                    // Reset project title
                    document.getElementById('projectTitle').value = 'Project name';
                    
                    // Remove all widgets
                    AppState.grid.removeAll();
                    
                    // Create default board
                    createDefaultBoard();
                    
                    showAutoSaveStatus('saved');
                }
            });
            
            // Backend modal
            document.getElementById('showBackend').addEventListener('click', () => {
                document.getElementById('backendModal').classList.add('active');
                updateDisplays();
            });
            document.getElementById('closeBackend').addEventListener('click', () => {
                document.getElementById('backendModal').classList.remove('active');
            });
            
            // Add section modal
            document.getElementById('addSection').addEventListener('click', () => {
                document.getElementById('addSectionModal').classList.add('active');
            });
            document.getElementById('closeAddSection').addEventListener('click', () => {
                document.getElementById('addSectionModal').classList.remove('active');
            });
            
            // Section type selection
            document.getElementById('sectionTypes').addEventListener('click', (e) => {
                const card = e.target.closest('.section-type-card');
                if (card) {
                    addSection(card.getAttribute('data-type'));
                    document.getElementById('addSectionModal').classList.remove('active');
                }
            });
            
            // Export
            document.getElementById('exportBoard').addEventListener('click', () => {
                const data = localStorage.getItem('vimplBoardState');
                if (data) {
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'vimpl-board-' + new Date().toISOString().split('T')[0] + '.json';
                    a.click();
                    URL.revokeObjectURL(url);
                }
            });
            
            // Post-it form events
            document.getElementById('closePostitForm').addEventListener('click', closePostitForm);
            
            ['formContent', 'formOwner', 'formStatus', 'formXValue', 'formYValue', 'formMitigation'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', () => {
                        savePostitForm();
                        if (id === 'formXValue' || id === 'formYValue') {
                            updateScoreDisplay();
                        }
                    });
                    el.addEventListener('change', savePostitForm);
                }
            });
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const tabName = tab.getAttribute('data-tab');
                    document.getElementById('eventsTab').style.display = tabName === 'events' ? 'block' : 'none';
                    document.getElementById('postitsTab').style.display = tabName === 'postits' ? 'block' : 'none';
                    document.getElementById('matrixTab').style.display = tabName === 'matrix' ? 'block' : 'none';
                });
            });
            
            // Close modals on outside click
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.remove('active');
                });
            });
            
            // Click outside to close postit form
            document.addEventListener('click', (e) => {
                const form = document.getElementById('postitForm');
                if (form.style.display !== 'none' && !form.contains(e.target) && !e.target.closest('.postit')) {
                    closePostitForm();
                }
            });
            
            // Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    AppState.selectedColor = null;
                    document.querySelectorAll('.postit-color').forEach(c => c.classList.remove('selected'));
                    document.body.style.cursor = 'default';
                    closePostitForm();
                }
            });
            
            // Save before unload
            window.addEventListener('beforeunload', () => {
                saveBoardState();
            });
            
            // Project title auto-save
            document.getElementById('projectTitle').addEventListener('input', scheduleAutoSave);
        });
    </script>
</body>
</html>
